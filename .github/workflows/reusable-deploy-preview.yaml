name: "Deploy Preview"

on:
  workflow_call:
    inputs:
      pr_number:
        required: true
        type: string
      commit_sha:
        required: true
        type: string
      project_name:
        required: true
        type: string
      repo_full_name:
        required: true
        type: string
      domain_preview:
        required: true
        type: string
      label_preview:
        required: true
        type: string
    secrets:
      VPS_HOST:
        required: true
      VPS_USER:
        required: true
      VPS_SSH_KEY:
        required: true
      DOCKERHUB_USERNAME:
        required: true
      ADMIN_EMAIL:
        required: true
      ADMIN_PASSWORD:
        required: true

permissions:
  pull-requests: write

jobs:
  deploy:
    runs-on: ubuntu-24.04
    environment:
      name: Preview
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            export SERVICE_NAME="${{ inputs.project_name }}-pr-${{ inputs.pr_number }}"
            export HOSTNAME="${{ inputs.project_name }}-pr-${{ inputs.pr_number }}.${{ inputs.domain_preview }}"
            export ROUTER_NAME="${{ inputs.project_name }}-pr-${{ inputs.pr_number }}"
            export IMAGE_NAME=${{ secrets.DOCKERHUB_USERNAME }}/${{ inputs.project_name }}:pr-${{ inputs.pr_number }}
            export LABEL_PREVIEW=${{ inputs.label_preview }}
            export PROJECT_NAME=${{ inputs.project_name }}
            export ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}
            export ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
            export FIRST_PREVIEW=false
            
            PROJECT_DIR=/var/www/${{ inputs.project_name }}/previews/pr-${{ inputs.pr_number }}

            if [ ! -d "$PROJECT_DIR" ]; then
              export FIRST_PREVIEW=true
              echo "Cloning repository for the first time at ${PROJECT_DIR}..."
              git clone "git@github.com:${{ inputs.repo_full_name }}.git" "${PROJECT_DIR}"
            fi

            cd "${PROJECT_DIR}"

            git fetch origin
            git checkout "${{ inputs.commit_sha }}"

            echo "Starting deployment for PR #${{ inputs.pr_number }}..."
            bash $PROJECT_DIR/deploy/preview/deploy-preview.sh
            echo "Deployment for PR #${{ inputs.pr_number }} finished."

      - name: Post Preview URL to PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          number: ${{ inputs.pr_number }}
          header: preview-url
          message: |
            **Preview ready!**
            Access it at: https://${{ inputs.project_name }}-pr-${{ inputs.pr_number }}.${{ inputs.domain_preview }}

            > Image: `${{ secrets.DOCKERHUB_USERNAME }}/${{ inputs.project_name }}:pr-${{ inputs.pr_number }}`